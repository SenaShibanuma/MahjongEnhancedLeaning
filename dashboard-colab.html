<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éº»é›€AI ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (Colab Connect)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Meiryo, system-ui; }
        .tile {
            width: 2.2rem; height: 3rem; line-height: 3rem;
            border: 1px solid #777; border-radius: 4px;
            background-color: #f0f0f0; color: #333;
            text-align: center; font-size: 1.5rem; margin: 2px;
            display: inline-block; user-select: none;
        }
        .tile.red { color: #c00; }
        .tile.facedown { background-color: #7ab56f; border-color: #5a9a4f; }
        .river-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; }
    </style>
</head>
<body class="bg-gray-800 text-white p-4">

    <div class="max-w-7xl mx-auto grid grid-cols-3 gap-6">
        <!-- å·¦å´: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
        <div class="col-span-1 bg-gray-900/50 p-4 rounded-lg">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-600 pb-2">å­¦ç¿’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            
            <!-- æ¥ç¶šè¨­å®šã‚¨ãƒªã‚¢ -->
            <div class="bg-gray-700 p-3 rounded-lg mb-4">
                <label for="ws-url" class="text-xs text-gray-400">Colab WebSocket URL</label>
                <div class="flex space-x-2 mt-1">
                    <input type="text" id="ws-url" placeholder="ws://..." class="w-full bg-gray-800 rounded px-2 py-1 text-sm border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="connect-btn" class="px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 text-sm">æ¥ç¶š</button>
                </div>
            </div>

            <div id="status-light" class="w-4 h-4 rounded-full bg-red-500 mb-4 inline-block"></div>
            <span id="status-text" class="ml-2">æœªæ¥ç¶š</span>
            
            <div class="space-y-4 text-lg">
                <div><p class="text-gray-400 text-sm">å­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—</p><p id="current-step" class="font-mono text-2xl">0</p></div>
                <div><p class="text-gray-400 text-sm">å¹³å‡å ±é…¬ (ç›´è¿‘100å±€)</p><p id="avg-reward" class="font-mono text-2xl">0.00</p></div>
                <div><p class="text-gray-400 text-sm">æå¤± (Loss)</p><p id="loss" class="font-mono text-2xl">0.0000</p></div>
            </div>

            <h3 class="text-xl font-bold mt-8 mb-4 border-b border-gray-600 pb-2">å½¹ ã‚µãƒãƒªãƒ¼</h3>
            <div id="yaku-summary" class="space-y-2 text-sm"><p class="text-gray-500">æ¥ç¶šå¾…æ©Ÿä¸­...</p></div>
        </div>

        <!-- å³å´: ç‰Œè­œãƒ“ãƒ¥ãƒ¼ã‚¢ (å¤‰æ›´ãªã—) -->
        <div class="col-span-2">
            <h1 class="text-3xl font-bold text-center mb-4">ç‰Œè­œãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
            <div class="bg-gray-700 p-4 rounded-lg mb-4 flex items-center space-x-4">
                <input type="file" id="kifu-input" class="text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                <button id="prev-btn" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50">ï¼œ å‰</button>
                <button id="next-btn" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 disabled:opacity-50">æ¬¡ ï¼</button>
                <span id="turn-info" class="text-lg font-mono">Turn: 0 / 0</span>
                <span id="event-info" class="text-sm text-gray-300 flex-grow">ç‰Œè­œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</span>
            </div>
            <div id="board" class="bg-green-800 border-4 border-yellow-700 p-4 rounded-lg grid grid-cols-3 grid-rows-3 gap-4" style="height: 60vh;">
                <div class="col-start-2"><div id="p2-river" class="river-grid mx-auto"></div><div id="p2-hand" class="flex justify-center mt-2"></div></div><div class="row-start-2 flex items-center"><div><div id="p1-river" class="river-grid"></div><div id="p1-hand" class="flex flex-col mt-2"></div></div></div><div id="center-info" class="row-start-2 col-start-2 bg-green-900/50 rounded-lg flex flex-col items-center justify-center"><p>ãƒ‰ãƒ©</p><div id="dora-indicator" class="tile"></div><p id="scores" class="mt-4 text-xs"></p></div><div class="row-start-2 col-start-3 flex items-center justify-end"><div><div id="p3-river" class="river-grid"></div><div id="p3-hand" class="flex flex-col mt-2"></div></div></div><div class="col-start-2 row-start-3 self-end"><div id="p0-hand" class="flex justify-center mb-2"></div><div id="p0-river" class="river-grid mx-auto"></div></div>
            </div>
            <div id="agari-info" class="mt-4 text-center text-xl font-bold text-yellow-300"></div>
        </div>
    </div>

<script>
    const statusLight = document.getElementById('status-light');
    const statusText = document.getElementById('status-text');
    const wsUrlInput = document.getElementById('ws-url');
    const connectBtn = document.getElementById('connect-btn');
    let socket;

    connectBtn.addEventListener('click', () => {
        const url = wsUrlInput.value;
        if (!url || !url.startsWith('ws://') && !url.startsWith('wss://')) {
            alert('æœ‰åŠ¹ãªWebSocket URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: ws://XXXX.ngrok.io)');
            return;
        }
        connectWebSocket(url);
    });

    function connectWebSocket(url) {
        if (socket) { socket.close(); }
        socket = new WebSocket(url);
        statusText.textContent = "æ¥ç¶šä¸­...";

        socket.onopen = (e) => {
            statusLight.className = 'w-4 h-4 rounded-full bg-green-500 mb-4 inline-block';
            statusText.textContent = "æ¥ç¶šæ¸ˆã¿";
        };
        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            document.getElementById('current-step').textContent = data.step;
            document.getElementById('avg-reward').textContent = data.avg_reward.toFixed(2);
            document.getElementById('loss').textContent = data.loss.toFixed(4);
            const yakuSummaryEl = document.getElementById('yaku-summary');
            yakuSummaryEl.innerHTML = '';
            if (data.yaku_summary.length > 0) {
                data.yaku_summary.forEach(([yaku, count]) => {
                    const p = document.createElement('p'); p.textContent = `${yaku}: ${count}`; yakuSummaryEl.appendChild(p);
                });
            } else { yakuSummaryEl.innerHTML = '<p class="text-gray-500">å½¹ã¯ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“...</p>'; }
        };
        socket.onclose = (event) => {
            statusLight.className = 'w-4 h-4 rounded-full bg-red-500 mb-4 inline-block';
            statusText.textContent = "æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ";
        };
        socket.onerror = (err) => {
            statusText.textContent = "æ¥ç¶šã‚¨ãƒ©ãƒ¼";
            console.error("WebSocket Error: ", err);
        }
    }

    // (ä»¥ä¸‹ã€ç‰Œè­œãƒ“ãƒ¥ãƒ¼ã‚¢ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
    const TILE_MAP={0:'ğŸ€‡',1:'ğŸ€ˆ',2:'ğŸ€‰',3:'ğŸ€Š',4:'ğŸ€‹',5:'ğŸ€Œ',6:'ğŸ€',7:'ğŸ€',8:'ğŸ€',9:'ğŸ€™',10:'ğŸ€š',11:'ğŸ€›',12:'ğŸ€œ',13:'ğŸ€',14:'ğŸ€',15:'ğŸ€Ÿ',16:'ğŸ€ ',17:'ğŸ€¡',18:'ğŸ€',19:'ğŸ€‘',20:'ğŸ€’',21:'ğŸ€“',22:'ğŸ€”',23:'ğŸ€•',24:'ğŸ€–',25:'ğŸ€—',26:'ğŸ€˜',27:'ğŸ€€',28:'ğŸ€',29:'ğŸ€‚',30:'ğŸ€ƒ',31:'ğŸ€„ï¸',32:'ğŸ€…',33:'ğŸ€†'};const AKA_DORA={16:true,52:true,88:true};let kifuEvents=[],currentIndex=-1,oyaPlayer=0;const fileInput=document.getElementById('kifu-input'),prevBtn=document.getElementById('prev-btn'),nextBtn=document.getElementById('next-btn');fileInput.addEventListener('change',e=>{const file=e.target.files[0];if(!file)return;const reader=new FileReader;reader.onload=event=>{try{kifuEvents=JSON.parse(event.target.result),currentIndex=0,renderState()}catch(err){alert("ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"),console.error(err)}};reader.readAsText(file)});prevBtn.addEventListener('click',()=>{currentIndex>0&&(currentIndex--,renderState())});nextBtn.addEventListener('click',()=>{currentIndex<kifuEvents.length-1&&(currentIndex++,renderState())});function tileIdToHtml(e){const t=Math.floor(e/4),n=AKA_DORA[e]||!1;return`<div class="tile ${n?"red":""}">${TILE_MAP[t]}</div>`}function renderState(){if(0===kifuEvents.length)return;const e=kifuEvents[currentIndex],t=e.hands_136,n=e.rivers;"INIT"===e.event_id&&(oyaPlayer=e.oya);const o=[0,1,2,3];for(let r=0;r<4;r++){const s=o[r],l=document.getElementById(`p${r}-hand`),a=document.getElementById(`p${r}-river`);l.innerHTML="";const d=t[s]||[];0===r?l.innerHTML=d.map(tileIdToHtml).join(""):l.innerHTML=Array(d.length).fill('<div class="tile facedown"></div>').join("");const i=n[s]||[];a.innerHTML=i.map(tileIdToHtml).join("")}document.getElementById("turn-info").textContent=`Turn: ${e.turn} / ${kifuEvents.length-1}`,document.getElementById("event-info").textContent=`Event: ${e.event_id} Player: ${e.player}`;const c=kifuEvents.find(e=>"INIT"===e.event_id);c&&(document.getElementById("dora-indicator").innerHTML=TILE_MAP[Math.floor(c.dora_indicators[0]/4)],document.getElementById("scores").textContent=`Scores: ${c.scores.join(", ")}`);const u=document.getElementById("agari-info");"AGARI"===e.event_id?u.textContent=`å’Œäº†! Player ${e.player} wins with ${e.yaku.join(", ")} for ${e.score} points.`:u.textContent="",prevBtn.disabled=currentIndex<=0,nextBtn.disabled=currentIndex>=kifuEvents.length-1}
</script>
</body>
</html>
